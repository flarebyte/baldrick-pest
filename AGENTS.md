# Repository Guidelines

## Project Structure & Module Organization

-   Source: `src/` (TypeScript, ESM). CLI entry: `src/cli.mts`; main
    exports in `src/index.ts`.

-   Tests: `test/*.test.ts` (Node test runner). Scenario examples in
    `pest-spec/` with snapshots.

-   Specs/fixtures: `spec/` holds schema and snapshot references.

-   Build output: `dist/src/` (generated by `tsc`). Do not edit files in
    `dist/`.

## Build, Test, and Development Commands

Primary (broth)

-   List tasks: `npx baldrick-broth@latest test` (see
    `baldrick-broth.yaml`).

-   Unit tests: `npx baldrick-broth@latest test unit` (Node `--test`).

-   Zest specs: `npx baldrick-broth@latest test spec` (declarative unit
    tests).

-   Pest acceptance: `npx baldrick-broth@latest test pest` (runs YAML
    suites in `pest-spec/`).

-   CLI dev run: `npx baldrick-broth@latest test cli` (use `--help` to see
    options).

-   Lint/format: `npx baldrick-broth@latest lint check|fix`, `npx
    baldrick-broth@latest md check|fix`.

-   Transpile: `npx baldrick-broth@latest transpile ts`. Docs: `npx
    baldrick-broth@latest doc ts`.

Fallback (yarn)

-   `yarn build` — compile TS to `dist/`. `yarn test` — run Node’s test
    runner.

-   `yarn cli` — run the CLI from sources. `yarn spec` — run Zest harness.

Examples

-   Run a sample suite: `npx baldrick-broth@latest test pest` or `yarn cli --file pest-spec/simple.pest.yaml`.
-   List all test commands: `npx baldrick-broth@latest test`.

Getting Started

-   Install deps: `yarn install`. Then list tasks with `npx
    baldrick-broth@latest test`.

## Coding Style & Naming Conventions

-   Language: TypeScript (strict mode). Node >= 22. ESM only.

-   Files: kebab-case modules (e.g., `run-regression-suite.ts`), tests end
    with `.test.ts`.

-   Exports: prefer named exports; avoid default exports.

-   Formatting: Prettier 2-space indent, single quotes, semicolons,
    trailing commas (`.prettierrc.json`). `.editorconfig` enforced.

## Testing Guidelines

-   Framework: Node `--test` with `ts-node/esm` loader (preferred via broth
    `test unit`).

-   Place unit tests under `test/` mirroring `src/` (e.g., `src/naming.ts`
    → `test/naming.test.ts`).

-   Keep tests deterministic; use snapshots in `pest-spec/snapshots/` when
    validating CLI output.

-   Run locally with broth: `npx baldrick-broth@latest test
    unit|spec|pest`.

-   Notes: `test pest1` is interactive (TTY required). The `jest` task is
    deprecated; prefer Node test runner.

## Dependency Canary Tests

-   Add concise smoke tests for production dependencies to detect breaking
    changes on upgrades without testing our own code.

-   Scope: import the dependency and exercise the small API surface we rely
    on. Keep assertions minimal; aim for import + basic success/failure.

-   Example: `test/zod-smoke.test.ts` imports `zod` and validates an object
    with `safeParse`, asserting a success case (defaults applied) and a
    failure case (issue paths captured).

-   Naming: “dependency canary tests”, “compatibility smoke tests”, or
    “third‑party integration smoke tests”.

-   Run with `yarn test` (also via `npx baldrick-broth@latest test unit`).

-   Current canaries:
    -   `chalk` — `test/chalk-smoke.test.ts`
    -   `commander` — `test/commander-smoke.test.ts`, `test/commander-subcommands-smoke.test.ts`
    -   `execa` — `test/execa-smoke.test.ts`
    -   `jest-diff` — `test/jest-diff-smoke.test.ts`
    -   `winston` — `test/winston-smoke.test.ts`
    -   `yaml` — `test/yaml-smoke.test.ts`, `test/yaml-edge-smoke.test.ts`
    -   `zod` — `test/zod-smoke.test.ts`

## Local Full Check

-   Install deps: `yarn install`.
-   Markdown lint: `npx baldrick-broth@latest md check`.
-   Code lint: `npx baldrick-broth@latest lint check`.
-   Direct XO details (optional): `npx xo 'src/**/*.ts'` and `npx xo src/execution.ts`.
-   Unit tests: `yarn test`.
-   Build CLI: `yarn build`.
-   Version: `node dist/src/cli.mjs -V`.
-   Sample spec: `node dist/src/cli.mjs test --spec-file pest-spec/simple.pest.yaml`.

## Known Issues / TODOs

-   Schema snapshot mismatch on `upgrade-deps` for `spec/pest-model/get-schema.zest.yaml`
    (after Zod v4 upgrade). See `TODO.md` for context and next steps.

## Release & PR Workflow

-   Pre-flight checks: `npx baldrick-broth@latest release ready [-pr]`
    (build, lint, markdown, tests, version check).

-   Create PR: `npx baldrick-broth@latest release pr` (uses the generated
    report).

-   Publish (maintainers): `npx baldrick-broth@latest release publish`.

## Commit & Pull Request Guidelines

-   Commit style observed: short, imperative summary; optional scope; PR
    numbers (e.g., `Tweaks to management of failed steps (#3)`). Keep
    related changes together.

-   PRs must include: concise description, rationale, before/after
    behavior, linked issue, and CLI examples when relevant. Update
    `USAGE.md` for user-facing changes.

## Security & Configuration Tips

-   No edits to generated `dist/`. Validate YAML with `zod` schemas in
    `src/pest-model.ts`.

-   CI detection via `src/is-ci.ts`; when simulating CI locally, set
    `CI=true` to test reporters.

## Local CLI Testing (subtle but important)

-   `broth test pest` runs the latest published `baldrick-pest` via `npx`,
    not your local sources. Use it only to validate the published package.

-   To test local changes to the CLI:

    -   Transpile first. Either `rm -rf dist && yarn build` or `npx
        baldrick-broth@latest transpile ts`.

    -   Then run from the built output: `node dist/src/cli.mjs test --spec-file
        pest-spec/simple.pest.yaml`.

    -   Quick version check: `node dist/src/cli.mjs -V` (or `--version`).

-   During development without transpiling, you can also run: `yarn cli`
    (ts-node) and pass the same flags.

## Node Version (nvm)

-   This project targets Node 22. Use nvm to select it:
    -   `nvm install 22` (first time)
    -   `nvm use` (reads `.nvmrc`)
    -   Verify with `node -v` → v22.x

## Version Bumps

-   Bump version to the next minor in all places:
    -   `package.json` → `version`.
    -   `src/version.ts` → exported `version` string.
    -   `baldrick-broth.yaml` → `model.project.version`.

-   After bumping, rebuild (`rm -rf dist && yarn build`) and validate with
    the local CLI command above.

-   Sanity check the version flag outputs the new version: `node
    dist/src/cli.mjs -V`.
